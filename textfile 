@Directive({
  selector: '[appAutoSave]'
})
export class AutoSaveDirective implements AfterViewInit, OnDestroy {
  @Output() autoSave = new EventEmitter<void>();

  constructor(private elRef: ElementRef) {}

  ngAfterViewInit() {
    // Listen in capture phase to never miss the click
    document.addEventListener('click', this.onClick, true);
  }

  ngOnDestroy() {
    document.removeEventListener('click', this.onClick, true);
  }

  onClick = (event: MouseEvent) => {
    const clickedInside = this.elRef.nativeElement.contains(event.target as Node);
    if (!clickedInside) {
      // ✅ Emit here — this will ALWAYS work even if Angular misses it
      this.autoSave.emit();
    }
  };
}